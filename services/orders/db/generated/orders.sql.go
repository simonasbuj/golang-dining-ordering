// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: orders.sql

package db

import (
	"context"
	"database/sql"
	"time"

	"github.com/google/uuid"
)

const addOrderItem = `-- name: AddOrderItem :one
INSERT INTO orders.orders_items (
    id,
    order_id,
    item_id,
    item_name,
    price_in_cents
) VALUES ($1, $2, $3, $4, $5)
RETURNING order_id
`

type AddOrderItemParams struct {
	ID           uuid.UUID     `json:"id"`
	OrderID      uuid.UUID     `json:"order_id"`
	ItemID       uuid.NullUUID `json:"item_id"`
	ItemName     string        `json:"item_name"`
	PriceInCents int           `json:"price_in_cents"`
}

func (q *Queries) AddOrderItem(ctx context.Context, arg AddOrderItemParams) (uuid.UUID, error) {
	row := q.db.QueryRowContext(ctx, addOrderItem,
		arg.ID,
		arg.OrderID,
		arg.ItemID,
		arg.ItemName,
		arg.PriceInCents,
	)
	var order_id uuid.UUID
	err := row.Scan(&order_id)
	return order_id, err
}

const createOrder = `-- name: CreateOrder :one
INSERT INTO orders.orders (
    id,
    table_id,
    currency
) VALUES ($1, $2, $3)
RETURNING id
`

type CreateOrderParams struct {
	ID       uuid.UUID `json:"id"`
	TableID  uuid.UUID `json:"table_id"`
	Currency string    `json:"currency"`
}

func (q *Queries) CreateOrder(ctx context.Context, arg CreateOrderParams) (uuid.UUID, error) {
	row := q.db.QueryRowContext(ctx, createOrder, arg.ID, arg.TableID, arg.Currency)
	var id uuid.UUID
	err := row.Scan(&id)
	return id, err
}

const deleteOrderItem = `-- name: DeleteOrderItem :exec
DELETE FROM orders.orders_items WHERE id = $1 and order_id = $2
`

type DeleteOrderItemParams struct {
	ID      uuid.UUID `json:"id"`
	OrderID uuid.UUID `json:"order_id"`
}

func (q *Queries) DeleteOrderItem(ctx context.Context, arg DeleteOrderItemParams) error {
	_, err := q.db.ExecContext(ctx, deleteOrderItem, arg.ID, arg.OrderID)
	return err
}

const getCurrentOrder = `-- name: GetCurrentOrder :one
SELECT id
FROM orders.orders
WHERE 
    table_id = $1 
    and status in ('open', 'locked')
    AND created_at >= NOW() - INTERVAL '8 hours'
ORDER BY created_at DESC
LIMIT 1
`

func (q *Queries) GetCurrentOrder(ctx context.Context, tableID uuid.UUID) (uuid.UUID, error) {
	row := q.db.QueryRowContext(ctx, getCurrentOrder, tableID)
	var id uuid.UUID
	err := row.Scan(&id)
	return id, err
}

const getMenuItem = `-- name: GetMenuItem :one
SELECT 
    i.id,
    m.id as restaurant_id,
    i.name,
    i.price_in_cents
FROM management.items i 
    LEFT JOIN management.categories c on c.id = i.category_id
    LEFT JOIN management.menus m on m.id = c.menu_id
WHERE i.id = $1
`

type GetMenuItemRow struct {
	ID           uuid.UUID     `json:"id"`
	RestaurantID uuid.NullUUID `json:"restaurant_id"`
	Name         string        `json:"name"`
	PriceInCents int           `json:"price_in_cents"`
}

func (q *Queries) GetMenuItem(ctx context.Context, id uuid.UUID) (GetMenuItemRow, error) {
	row := q.db.QueryRowContext(ctx, getMenuItem, id)
	var i GetMenuItemRow
	err := row.Scan(
		&i.ID,
		&i.RestaurantID,
		&i.Name,
		&i.PriceInCents,
	)
	return i, err
}

const getOrderItems = `-- name: GetOrderItems :many
SELECT
    o.id,
    r.id as restaurant_id,
    r.name as restaurant_name,
    o.status,
    o.currency,
    o.tip_amount_in_cents,
    o.updated_at,
    i.id as order_item_id,
    i.item_id,
    i.item_name,
    i.price_in_cents
FROM orders.orders o
    LEFT JOIN orders.orders_items i ON o.id = i.order_id
    LEFT JOIN management.tables t on t.id = o.table_id
    LEFT JOIN management.restaurants r on r.id = t.restaurant_id
WHERE o.id = $1
`

type GetOrderItemsRow struct {
	ID               uuid.UUID      `json:"id"`
	RestaurantID     uuid.NullUUID  `json:"restaurant_id"`
	RestaurantName   sql.NullString `json:"restaurant_name"`
	Status           OrderStatus    `json:"status"`
	Currency         string         `json:"currency"`
	TipAmountInCents sql.NullInt32  `json:"tip_amount_in_cents"`
	UpdatedAt        time.Time      `json:"updated_at"`
	OrderItemID      uuid.NullUUID  `json:"order_item_id"`
	ItemID           uuid.NullUUID  `json:"item_id"`
	ItemName         sql.NullString `json:"item_name"`
	PriceInCents     sql.NullInt32  `json:"price_in_cents"`
}

func (q *Queries) GetOrderItems(ctx context.Context, id uuid.UUID) ([]GetOrderItemsRow, error) {
	rows, err := q.db.QueryContext(ctx, getOrderItems, id)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetOrderItemsRow
	for rows.Next() {
		var i GetOrderItemsRow
		if err := rows.Scan(
			&i.ID,
			&i.RestaurantID,
			&i.RestaurantName,
			&i.Status,
			&i.Currency,
			&i.TipAmountInCents,
			&i.UpdatedAt,
			&i.OrderItemID,
			&i.ItemID,
			&i.ItemName,
			&i.PriceInCents,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getTableCurrency = `-- name: GetTableCurrency :one
SELECT r.currency
FROM management.restaurants r
WHERE r.id = (select restaurant_id from management.tables t where t.id = $1)
`

func (q *Queries) GetTableCurrency(ctx context.Context, id uuid.UUID) (string, error) {
	row := q.db.QueryRowContext(ctx, getTableCurrency, id)
	var currency string
	err := row.Scan(&currency)
	return currency, err
}

const isUserRestaurantWaiter = `-- name: IsUserRestaurantWaiter :one
SELECT id, user_id, restaurant_id, created_at, updated_at
FROM management.restaurants_waiters
WHERE user_id = $1
  AND restaurant_id = $2
`

type IsUserRestaurantWaiterParams struct {
	UserID       uuid.UUID `json:"user_id"`
	RestaurantID uuid.UUID `json:"restaurant_id"`
}

// Check if a user is a waiter for a given restaurant
func (q *Queries) IsUserRestaurantWaiter(ctx context.Context, arg IsUserRestaurantWaiterParams) (ManagementRestaurantsWaiter, error) {
	row := q.db.QueryRowContext(ctx, isUserRestaurantWaiter, arg.UserID, arg.RestaurantID)
	var i ManagementRestaurantsWaiter
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RestaurantID,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const updateOrder = `-- name: UpdateOrder :exec
UPDATE orders.orders
SET
    status = COALESCE($2, status),
    tip_amount_in_cents = COALESCE($3, tip_amount_in_cents),
    updated_at = NOW()
WHERE id = $1
`

type UpdateOrderParams struct {
	ID               uuid.UUID       `json:"id"`
	Status           NullOrderStatus `json:"status"`
	TipAmountInCents sql.NullInt32   `json:"tip_amount_in_cents"`
}

func (q *Queries) UpdateOrder(ctx context.Context, arg UpdateOrderParams) error {
	_, err := q.db.ExecContext(ctx, updateOrder, arg.ID, arg.Status, arg.TipAmountInCents)
	return err
}
